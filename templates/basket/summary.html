{% extends "product_base.html" %}
{% load static %}
{% block stylesheet %}
    {% static 'basket/css/basket.css' %}
{% endblock %}
{% block title %}
    Vỏ hàng
{% endblock %}
{% block basket %}
    sidebar__item-active
{% endblock %}
{% block basket_mobile %}
    nav_bottom__link--active
{% endblock %}
{% block content %}
    <div class="body-basket" id="example">
        <div class="grid">
            <div class="container-basket">
                <div class="basket__title">
                    <h1>Vỏ hàng của bạn</h1>
                    <p>Quản lí các <span>sản phẩm</span> trong vỏ hàng của bạn</p>
                </div>
                {% if messages %}
                    <div class="log__alert-successfully" role="alert">
                        {% for message in messages %}
                            {{ message|safe }}
                            <a href="{% url 'account:user_save_list' %}" class="alert-link">tại đây</a>
                        {% endfor %}
                    </div>
                {% endif %}
                {% if basket|length == 0 %}
                    {% if user.is_authenticated %}
                        <div class="row">
                            <div class="col l-12 m-12 c-12">
                                <p class="baket__none">Vỏ hàng của bạn đang trống. Bạn có thế xem thêm <a
                                        class="btn-basket-all btn btn-white btn-animate"
                                        href="{% url 'store:product_all' %}">tại
                                    đây</a> hoặc
                                    <select style="margin:10px 0; padding: 6px; font-size: 1.6rem;"
                                            onchange="location = this.value;">
                                        <option hidden> Lựa chọn giỏ hàng có sẵn mà bạn muốn</option>
                                        {% for saveItem in savels %}
                                            <option style="padding: 6px;"
                                                    value="{% url 'basket:basket_list_add_by_id' saveItem.id %}">
                                                {% if saveItem.title == "None" %}
                                                    Giỏ hàng chưa được đặt tên
                                                {% else %}
                                                    {{ saveItem.title }}
                                                {% endif %}
                                            </option>
                                        {% endfor %}
                                    </select>
                                </p>

                            </div>
                        </div>
                    {% else %}
                        <div class="row">
                            <div class="col l-12 m-12 c-12">
                                <p class="baket__none">Vỏ hàng của bạn đang trống. Bạn có thế xem thêm <a
                                        class="btn-basket-all btn btn-white btn-animate"
                                        href="{% url 'store:product_all' %}">tại
                                    đây</a> hoặc
                                    <a
                                            class="btn-basket-all btn btn-white btn-animate"
                                            href="{% url 'account:login' %}"> đăng nhập</a>
                                    để sử dụng vỏ hàng có sẵn
                                </p>

                            </div>
                        </div>
                    {% endif %}
                {% else %}
                    <div class="basket__price-top">
                        <div class="row">
                            <div class="col l-6 m-6 c-12">
                                <div class="basket__select">
                                    <a href="{% url 'store:product_all' %}">Mua tiếp</a>
                                </div>
                            </div>
                            <div class="col l-6 m-6 c-12">
                                <div class="basket__total-price">
                                    <p>Tổng tiền: <span
                                            id="basket-totalPrice__sub">{{ basket.get_subtotal_price }} Đ</span>
                                    </p>
                                    <p>Giảm giá: <span>0 Đ</span></p>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="basket__price-bottom">
                        <div class="row">
                            <div class="col l-12 m-12 c-12">
                                <div class="basket__total-to-pay">
                                    <p>Tổng tiền cần thanh toán: <span
                                            id="basket-totalPrice__sub-total">{{ basket.get_subtotal_price }}Đ</span>
                                    </p>
                                </div>
                            </div>

                        </div>
                    </div>

                    <div class="basket-wrapper">
                        <div class="row">
                            <div class="col l-8 m-12 c-12">
                                {% for item in basket %}
                                    {% with product=item.product %}
                                        <div data-index="{{ product.id }}" class="basket__product">
                                            <div class="row">
                                                <div class="col l-4 m-4 c-12">
                                                    <div class="basket__wrap-img">
                                                        <div class="basket__img">
                                                            {% for image in product.product_image.all %}
                                                                {% if image.is_feature %}
                                                                    <a style="text-decoration: none;"
                                                                       href="{{ product.get_absolute_url }}"><img
                                                                            src="{{ image.image.url }}"
                                                                            alt="{{ image.image.alt_text }}"
                                                                            class="section-product__header-img"></a>

                                                                {% endif %}
                                                            {% endfor %}
                                                        </div>
                                                        <div class="basket__price">
                                                            <p>Giá:</p>
                                                            <span>{{ product.regular_price }} VND</span>
                                                        </div>
                                                    </div>
                                                </div>
                                                <div class="col l-8 m-8 c-12">
                                                    <div class="basket__info">
                                                        <div class="basket__info-name">
                                                            <a class="basket__info-link"
                                                               href="{{ product.get_absolute_url }}">
                                                                <p>{{ product.title }}</p></a>
                                                        </div>
                                                        <div class="basket__shell">
                                                            <div class="basket__info-quantityArea">
                                                                <label for="select">Số lượng: </label>
                                                                <select class="select" id="select{{ product.id }}">
                                                                    <option hidden
                                                                            selected>{{ item.qty }}</option>
                                                                    <option value="1">1</option>
                                                                    <option value="2">2</option>
                                                                    <option value="3">3</option>
                                                                    <option value="4">4</option>
                                                                    <option value="5">5</option>
                                                                    <option value="6">6</option>
                                                                    <option value="7">7</option>
                                                                    <option value="8">8</option>
                                                                    <option value="9">9</option>
                                                                    <option value="10">10</option>
                                                                </select>
                                                            </div>
                                                            <div class="basket__btn">
                                                                <button onclick="showSuccessToastUpdatePro()"
                                                                        class="basket__info-btn basket__info-btn--update btn btn-white btn-animate"
                                                                        id="update-btn" data-index="{{ product.id }}">
                                                                    Cập
                                                                    nhập
                                                                </button>
                                                                <button onclick="showSuccessToastDeletePro()"
                                                                        class="basket__info-btn basket__info-btn--delete btn btn-black btn-animate"
                                                                        id="delete-btn" data-index="{{ product.id }}">
                                                                    Xóa
                                                                </button>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    {% endwith %}
                                {% endfor %}
                            </div>
                            <div class="col l-4 m-12 c-12">
                                <div class="basket__checkout-btn">
                                    {% if user.is_authenticated %}
                                        <a role="button" type="button" href="{% url 'checkout:delivery_choices' %}"
                                           class="basket__info-btn--checkout btn btn-white btn-animate">Đặt món</a>
                                        <a href="{% url 'account:user_save_list' %}"
                                           class="basket__info-btn--save btn btn-black btn-animate">Lưu lại cho lần
                                            sau
                                        </a>
                                    {% else %}
                                        <p style="font-size: 1.6rem; color: var(--primary-color); font-weight: 600;">Bạn
                                            chưa đăng nhập, hãy:</p>
                                        <a role="button" type="button" href="{% url 'checkout:delivery_choices' %}"
                                           class="basket__info-btn--checkout btn btn-white btn-animate">Đặt món qua tài
                                            khoản</a>
                                        {% if form.errors %}
                                            <p style="font-size: 1.6rem; font-weight: 600;margin-bottom: 6px;">Xin vui lòng sửa những lỗi sau:</p>
                                            {% for field in form %}
                                                {% if field.errors %}
                                                    <div class="log__errors" role="alert">
                                                        {{ field.label }}: {{ field.errors|striptags }}
                                                    </div>
                                                {% endif %}
                                            {% endfor %}
                                        {% endif %}
                                        <button class="basket__info-btn--save btn btn-black btn-animate"
                                                onclick="btn_hide_show()">Đặt món qua số điện
                                        </button>
                                        <div id="myDIV">
                                            <form action="{% url 'basket:basket_summary' %}" method="POST">
                                                {% csrf_token %}
                                                {{ form }}
                                                <button hidden type="submit"></button>
                                            </form>
                                        </div>
                                        <script>
                                            function btn_hide_show() {
                                                var x = document.getElementById("myDIV");
                                                if (x.style.display === "block") {
                                                    x.style.display = "none";
                                                } else {
                                                    x.style.display = "block";
                                                }
                                            }
                                        </script>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
    <script>
        //basket

        $(document).on('click', '.basket__info-btn--delete', function (e) {
            e.preventDefault();
            var prodId = $(this).data('index');
            $.ajax({
                type: 'POST',
                url: '{% url "basket:basket_delete" %}',
                data: {
                    productid: $(this).data('index'),
                    csrfmiddlewaretoken: "{{csrf_token}}",
                    action: 'post'
                },
                success: function (json) {
                    if (json.qty == 0)
                        location.reload();
                    $('.basket__product[data-index="' + prodId + '"]').remove();
                    document.getElementById('mobile_cart-quantity__num').innerHTML = json.qty
                    document.getElementById('cart-quantity__num').innerHTML = json.qty
                    document.getElementById('basket-totalPrice__sub').innerHTML = json.subtotal + ' VNĐ'
                    document.getElementById('basket-totalPrice__sub-total').innerHTML = json.subtotal + ' VNĐ'
                },
                error: function (xhr, errmsg, err) {

                }
            });
        })
        //basket

        $(document).on('click', '.basket__info-btn--update', function (e) {
            e.preventDefault();
            var prodId = $(this).data('index');
            $.ajax({
                type: 'POST',
                url: '{% url "basket:basket_update" %}',
                data: {
                    productid: $(this).data('index'),
                    productqty: $('#select' + prodId + ' option:selected').text(),
                    csrfmiddlewaretoken: "{{csrf_token}}",
                    action: 'post'
                },
                success: function (json) {
                    document.getElementById('mobile_cart-quantity__num').innerHTML = json.qty
                    document.getElementById('cart-quantity__num').innerHTML = json.qty
                    document.getElementById('basket-totalPrice__sub').innerHTML = json.subtotal + ' VNĐ'
                    document.getElementById('basket-totalPrice__sub-total').innerHTML = json.subtotal + ' VNĐ'

                },
                error: function (xhr, errmsg, err) {

                }
            });
        })
    </script>
{% endblock %}